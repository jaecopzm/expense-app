name: WizeBudge CI

# --- Ensure Releases can be published ---
permissions:
  contents: write   # REQUIRED to create releases
  actions: read

on:
  push:
    branches: [main, develop]
    tags: ["v*"]     # Publish only on version tags
  pull_request:
    branches: [main, develop]

jobs:

  analyze_test:
    name: Analyze & Test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.35.7"
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      # - name: Flutter analyze
      #   run: flutter analyze --no-fatal-infos

      # - name: Run tests
      #   run: flutter test --coverage || true

      - name: Upload Test Coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false

  build:
    name: Build Android Release
    needs: analyze_test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.35.7"
          channel: stable
          cache: true

      - name: Build APK
        run: flutter build apk --release --split-per-abi

      - name: Build AAB
        run: flutter build appbundle --release

      - name: Upload APKs
        uses: actions/upload-artifact@v4
        with:
          name: apks
          path: build/app/outputs/flutter-apk/*.apk

      - name: Upload AAB
        uses: actions/upload-artifact@v4
        with:
          name: aab
          path: build/app/outputs/bundle/release/*.aab

  release:
    name: Publish Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download APKs
        uses: actions/download-artifact@v4
        with:
          name: apks
          path: artifacts

      - name: Download AAB
        uses: actions/download-artifact@v4
        with:
          name: aab
          path: artifacts

      - name: Create Release Notes
        run: |
          echo "# WizeBudge ${GITHUB_REF_NAME}" > notes.md
          echo "See changelog for full details." >> notes.md

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**
          body_path: notes.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}   # NOW HAS RELEASE PERMISSION
